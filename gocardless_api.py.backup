"""
GoCardless API Module for SideKick
Copyright (c) 2026 GuyMayer. All rights reserved.
Unauthorized use, modification, or distribution is prohibited.

CLI Usage:
  --check-mandate <email>           Check if customer has active mandate
  --create-billing-request <json>   Create billing request flow for mandate setup
  --test-connection                 Test API connection and return creditor info
  
Output format: STATUS|field1|field2|...
"""

import sys
import os
import json
import base64
import argparse
import configparser
from urllib.parse import quote
from typing import Optional, Dict, Any

# =============================================================================
# SCRIPT DIRECTORY - Handle both script and frozen exe
# =============================================================================
if getattr(sys, 'frozen', False):
    SCRIPT_DIR = os.path.dirname(sys.executable)
else:
    SCRIPT_DIR = os.path.dirname(os.path.abspath(__file__))

# =============================================================================
# CONFIGURATION LOADING
# =============================================================================

def _find_ini_file() -> str:
    """Find the SideKick INI file."""
    possible_paths = [
        os.path.join(SCRIPT_DIR, "SideKick_PS.ini"),
        os.path.join(os.path.dirname(SCRIPT_DIR), "SideKick_PS.ini"),
        os.path.join(os.environ.get('APPDATA', ''), "SideKick_PS", "SideKick_PS.ini"),
        # Also check for LB version
        os.path.join(SCRIPT_DIR, "SideKick_LB.ini"),
        os.path.join(os.path.dirname(SCRIPT_DIR), "SideKick_LB.ini"),
        os.path.join(os.environ.get('APPDATA', ''), "SideKick_LB", "SideKick_LB.ini"),
    ]
    for path in possible_paths:
        if os.path.exists(path):
            return path
    raise FileNotFoundError("Could not find SideKick INI file")


def load_config() -> Dict[str, Any]:
    """Load GoCardless configuration from credentials.json and INI file.
    
    Returns:
        dict: Configuration with gc_token, environment, ghl_api_key, location_id
    """
    gc_token = ""
    environment = "sandbox"
    ghl_api_key = ""
    location_id = ""
    
    # Load from credentials.json (primary source for tokens)
    credentials_paths = [
        os.path.join(SCRIPT_DIR, "credentials.json"),
        os.path.join(os.environ.get('APPDATA', ''), "SideKick_PS", "credentials.json"),
        os.path.join(os.environ.get('APPDATA', ''), "SideKick_LB", "credentials.json"),
    ]
    
    for cred_path in credentials_paths:
        if os.path.exists(cred_path):
            try:
                with open(cred_path, 'r', encoding='utf-8-sig') as f:
                    creds = json.load(f)
                
                # GoCardless token
                gc_token_b64 = creds.get('gc_token_b64', '')
                if gc_token_b64:
                    gc_token = base64.b64decode(gc_token_b64).decode('utf-8')
                
                # GHL credentials (for sending emails/SMS)
                api_key_b64 = creds.get('api_key_b64', '')
                if api_key_b64:
                    ghl_api_key = base64.b64decode(api_key_b64).decode('utf-8')
                
                location_id = creds.get('location_id', '')
                break
            except Exception as e:
                pass
    
    # Load environment from INI file
    try:
        ini_path = _find_ini_file()
        config = configparser.ConfigParser()
        config.read(ini_path, encoding='utf-8')
        
        if config.has_section('GoCardless'):
            environment = config.get('GoCardless', 'Environment', fallback='sandbox')
    except Exception:
        pass
    
    if not gc_token:
        raise ValueError("No GoCardless token found in credentials.json")
    
    return {
        'gc_token': gc_token,
        'environment': environment,
        'ghl_api_key': ghl_api_key,
        'location_id': location_id,
    }


def get_api_url(environment: str) -> str:
    """Get GoCardless API URL based on environment."""
    if environment == "live":
        return "https://api.gocardless.com"
    return "https://api-sandbox.gocardless.com"


# =============================================================================
# HTTP REQUESTS
# =============================================================================

def gc_request(method: str, endpoint: str, token: str, environment: str, 
               data: Optional[dict] = None, timeout: int = 30) -> Dict[str, Any]:
    """Make a request to GoCardless API.
    
    Args:
        method: HTTP method (GET, POST, etc.)
        endpoint: API endpoint path
        token: GoCardless API token
        environment: "sandbox" or "live"
        data: JSON body for POST requests
        timeout: Request timeout in seconds
        
    Returns:
        dict: Response JSON or error dict
    """
    import urllib.request
    import urllib.error
    
    url = get_api_url(environment) + endpoint
    headers = {
        'Authorization': f'Bearer {token}',
        'GoCardless-Version': '2015-07-06',
        'Content-Type': 'application/json',
    }
    
    body = json.dumps(data).encode('utf-8') if data else None
    
    try:
        req = urllib.request.Request(url, data=body, headers=headers, method=method)
        with urllib.request.urlopen(req, timeout=timeout) as response:
            return json.loads(response.read().decode('utf-8'))
    except urllib.error.HTTPError as e:
        error_body = ""
        try:
            error_body = e.read().decode('utf-8')
            error_data = json.loads(error_body)
            error_msg = error_data.get('error', {}).get('message', str(e))
        except:
            error_msg = f"{e.code} {e.reason}: {error_body[:200]}" if error_body else f"{e.code} {e.reason}"
        return {'error': error_msg, 'status_code': e.code}
    except urllib.error.URLError as e:
        return {'error': f"Connection error: {e.reason}"}
    except Exception as e:
        return {'error': str(e)}


# =============================================================================
# GOCARDLESS API FUNCTIONS
# =============================================================================

def test_connection(token: str, environment: str) -> Dict[str, Any]:
    """Test GoCardless API connection.
    
    Returns:
        dict: {success: bool, creditor_name: str, creditor_id: str, error: str}
    """
    result = gc_request('GET', '/creditors', token, environment)
    
    if 'error' in result:
        return {'success': False, 'error': result['error']}
    
    creditors = result.get('creditors', [])
    if not creditors:
        return {'success': False, 'error': 'No creditors found'}
    
    creditor = creditors[0]
    return {
        'success': True,
        'creditor_name': creditor.get('name', 'Unknown'),
        'creditor_id': creditor.get('id', ''),
    }


def check_customer_mandate(email: str, token: str, environment: str) -> Dict[str, Any]:
    """Check if a customer has an active mandate.
    
    Args:
        email: Customer email address
        token: GoCardless API token
        environment: "sandbox" or "live"
        
    Returns:
        dict: {has_mandate: bool, mandate_id: str, mandate_status: str, 
               bank_name: str, customer_id: str, error: str}
    """
    result = {
        'has_mandate': False,
        'mandate_id': '',
        'mandate_status': '',
        'bank_name': '',
        'customer_id': '',
        'error': '',
    }
    
    # Step 1: Find customer by email
    encoded_email = quote(email, safe='')
    customers_resp = gc_request('GET', f'/customers?email={encoded_email}', token, environment)
    
    if 'error' in customers_resp:
        result['error'] = customers_resp['error']
        return result
    
    customers = customers_resp.get('customers', [])
    if not customers:
        # No customer found - not an error, just no mandate
        return result
    
    customer_id = customers[0].get('id', '')
    result['customer_id'] = customer_id
    
    # Step 2: Get mandates for this customer
    mandates_resp = gc_request('GET', f'/mandates?customer={customer_id}', token, environment)
    
    if 'error' in mandates_resp:
        result['error'] = mandates_resp['error']
        return result
    
    mandates = mandates_resp.get('mandates', [])
    if not mandates:
        # Customer exists but no mandates
        return result
    
    # Step 3: Find active mandate
    active_statuses = ['active', 'pending_submission', 'submitted']
    for mandate in mandates:
        if mandate.get('status') in active_statuses:
            result['has_mandate'] = True
            result['mandate_id'] = mandate.get('id', '')
            result['mandate_status'] = mandate.get('status', '')
            
            # Try to get bank account name
            bank_account_id = mandate.get('links', {}).get('customer_bank_account', '')
            if bank_account_id:
                bank_resp = gc_request('GET', f'/customer_bank_accounts/{bank_account_id}', 
                                       token, environment, timeout=10)
                if 'error' not in bank_resp:
                    bank_accounts = bank_resp.get('customer_bank_accounts', {})
                    # Handle both list and single object response
                    if isinstance(bank_accounts, list) and bank_accounts:
                        result['bank_name'] = bank_accounts[0].get('bank_name', 'Bank account')
                    elif isinstance(bank_accounts, dict):
                        result['bank_name'] = bank_accounts.get('bank_name', 'Bank account')
                    else:
                        result['bank_name'] = 'Bank account'
            
            return result
    
    # No active mandate found
    return result


def create_billing_request_flow(contact_data: dict, token: str, environment: str,
                                ghl_api_key: str = '', location_id: str = '') -> Dict[str, Any]:
    """Create a billing request flow for mandate setup.
    
    Args:
        contact_data: {email, first_name, last_name, phone, contact_id}
        token: GoCardless API token
        environment: "sandbox" or "live"
        ghl_api_key: GHL API key for sending notifications
        location_id: GHL location ID
        
    Returns:
        dict: {success: bool, flow_url: str, billing_request_id: str, error: str}
    """
    result = {
        'success': False,
        'flow_url': '',
        'billing_request_id': '',
        'error': '',
    }
    
    email = contact_data.get('email', '')
    first_name = contact_data.get('first_name', '')
    last_name = contact_data.get('last_name', '')
    
    if not email:
        result['error'] = 'No email address provided'
        return result
    
    # Step 1: Create billing request
    billing_request_data = {
        'billing_requests': {
            'mandate_request': {
                'scheme': 'bacs',  # UK Direct Debit
            },
        }
    }
    
    br_resp = gc_request('POST', '/billing_requests', token, environment, billing_request_data)
    
    if 'error' in br_resp:
        result['error'] = f"Failed to create billing request: {br_resp['error']}"
        return result
    
    billing_request = br_resp.get('billing_requests', {})
    billing_request_id = billing_request.get('id', '')
    
    if not billing_request_id:
        result['error'] = 'No billing request ID returned'
        return result
    
    result['billing_request_id'] = billing_request_id
    
    # Step 2: Create billing request flow
    flow_data = {
        'billing_request_flows': {
            'redirect_uri': 'https://example.com/mandate-complete',
            'exit_uri': 'https://example.com/mandate-exit',
            'links': {
                'billing_request': billing_request_id,
            },
            'prefilled_customer': {
                'email': email,
                'given_name': first_name,
                'family_name': last_name,
            },
        }
    }
    
    flow_resp = gc_request('POST', '/billing_request_flows', token, environment, flow_data)
    
    if 'error' in flow_resp:
        result['error'] = f"Failed to create flow: {flow_resp['error']}"
        return result
    
    flow = flow_resp.get('billing_request_flows', {})
    flow_url = flow.get('authorisation_url', '')
    
    if not flow_url:
        result['error'] = 'No authorisation URL returned'
        return result
    
    result['success'] = True
    result['flow_url'] = flow_url
    
    return result


# =============================================================================
# CLI INTERFACE
# =============================================================================

def main():
    """Main CLI entry point."""
    is_frozen = getattr(sys, 'frozen', False)
    
    if is_frozen:
        parser = argparse.ArgumentParser(add_help=False)
    else:
        parser = argparse.ArgumentParser(
            description='GoCardless API integration for SideKick',
            formatter_class=argparse.RawDescriptionHelpFormatter,
            epilog="""
Examples:
  %(prog)s --test-connection
  %(prog)s --check-mandate user@example.com
  %(prog)s --create-billing-request '{"email": "user@example.com", "first_name": "John"}'
            """
        )
    
    parser.add_argument('--test-connection', action='store_true',
                        help='Test API connection and return creditor info')
    parser.add_argument('--check-mandate', type=str, metavar='EMAIL',
                        help='Check if customer has active mandate')
    parser.add_argument('--create-billing-request', type=str, metavar='JSON',
                        help='Create billing request flow (JSON: email, first_name, last_name)')
    
    args = parser.parse_args()
    
    # Load configuration
    try:
        config = load_config()
    except Exception as e:
        print(f"ERROR|{e}")
        sys.exit(1)
    
    gc_token = config['gc_token']
    environment = config['environment']
    
    # Handle commands
    if args.test_connection:
        result = test_connection(gc_token, environment)
        if result['success']:
            print(f"SUCCESS|{result['creditor_name']}|{result['creditor_id']}")
        else:
            print(f"ERROR|{result['error']}")
    
    elif args.check_mandate:
        result = check_customer_mandate(args.check_mandate, gc_token, environment)
        if result['error']:
            print(f"ERROR|{result['error']}")
        elif result['has_mandate']:
            print(f"MANDATE_FOUND|{result['customer_id']}|{result['mandate_id']}|{result['mandate_status']}|{result['bank_name']}")
        elif result['customer_id']:
            print(f"NO_MANDATE|{result['customer_id']}")
        else:
            print("NO_CUSTOMER")
    
    elif args.create_billing_request:
        try:
            contact_data = json.loads(args.create_billing_request)
        except json.JSONDecodeError as e:
            print(f"ERROR|Invalid JSON: {e}")
            sys.exit(1)
        
        result = create_billing_request_flow(
            contact_data, gc_token, environment,
            config.get('ghl_api_key', ''), config.get('location_id', '')
        )
        
        if result['success']:
            print(f"SUCCESS|{result['billing_request_id']}|{result['flow_url']}")
        else:
            print(f"ERROR|{result['error']}")
    
    else:
        parser.print_help()
        sys.exit(1)


if __name__ == '__main__':
    main()
